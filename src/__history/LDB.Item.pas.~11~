unit LDB.Item;

interface
type
TItem = class
private
    FidItem: integer;
    FprecoCusto: double;
    Fdescricao: String;
    FprecoVenda: double;
    Ffg_ativo: integer;
    procedure Setdescricao(const Value: String);
    procedure Setfg_ativo(const Value: integer);
    procedure SetidItem(const Value: integer);
    procedure SetprecoCusto(const Value: double);
    procedure SetprecoVenda(const Value: double);
protected
public
property idItem : integer read FidItem write SetidItem;
property descricao : String read Fdescricao write Setdescricao;
property precoCusto : double read FprecoCusto write SetprecoCusto;
property precoVenda : double read FprecoVenda write SetprecoVenda;
property fg_ativo : integer read Ffg_ativo write Setfg_ativo;
function pesquisar(id : integer):TItem;
function inserir(i : TItem):integer;
published
end;
implementation

uses LDB.SQL.DataModule;

{ TItem }

function TItem.inserir(i: TItem): integer;
var
 id : integer;
begin
with LDB.SQL.DataModule.dm.QueryEstoque do
  begin
    Close;
    SQL.Clear;
    SQL.Add('INSERT INTO tb_item (ds_item, preco_custo, preco_venda, fg_ativo)');
    SQL.Add('VALUES (:descricao, :preco_custo, :preco_venda, :fg_ativo);');

    ParamByName('descricao').Value := i.descricao;
    ParamByName('preco_custo').Value := i.precoCusto;
    ParamByName('preco_venda').Value := i.precoVenda;
    ParamByName('fg_ativo').Value := i.fg_ativo;

    ExecSQL;

    Close;
    SQL.Clear;
    SQL.Add('SELECT LAST_INSERT_ID() as id_cliente;');
    Open;

    if RowsAffected > 0 then
    begin
      id := FieldByName('id_cliente').AsInteger;;
      Close;
      SQL.Clear;
      SQL.Add('INSERT INTO tb_estoque (id_item, quantidade)');
      SQL.Add('VALUES (:id, 0);');
      ParamByName('id').Value := id;
      ExecSQL;
      Result := id;
    end
    else
    begin
      Result := -1;
    end;
  end;
end;

function TItem.pesquisar(id: integer): TItem;
begin
  with LDB.SQL.DataModule.dm.QueryEstoque do
  begin
    Close;
    SQL.Clear;
    //SQL.Add('SELECT i.id_item AS ID, i.ds_item AS Descrição, i.preco_custo AS "Preço Custo", i.preco_venda AS "Preço Venda", e.quantidade AS Quantidade FROM tb_item AS i INNER JOIN tb_estoque as e ON (i.id_item = e.id_item) WHERE i.fg_ativo = 1 AND i.id_item ');
    SQL.Add('SELECT * FROM tb_item WHERE id_item = :id');
    ParamByName('id').Value := id;
    Open;
    Self.FIdItem := FieldByName('id_item').AsInteger;
    Self.FDescricao := FieldByName('ds_item').AsString;
    Self.FprecoCusto := FieldByName('preco_custo').AsFloat;
    Self.FprecoVenda := FieldByName('preco_venda').AsFloat;
    Self.Ffg_ativo := FieldByName('fg_ativo').AsInteger;
    Result := Self;
  end;
end;

procedure TItem.Setdescricao(const Value: String);
begin
  Fdescricao := Value;
end;

procedure TItem.Setfg_ativo(const Value: integer);
begin
  Ffg_ativo := Value;
end;

procedure TItem.SetidItem(const Value: integer);
begin
  FidItem := Value;
end;

procedure TItem.SetprecoCusto(const Value: double);
begin
  FprecoCusto := Value;
end;

procedure TItem.SetprecoVenda(const Value: double);
begin
  FprecoVenda := Value;
end;

end.
